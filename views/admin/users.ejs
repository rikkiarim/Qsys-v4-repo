<% layout('layouts/main') %>
<section class="admin-content">
  <h1 class="page-title" style="margin-bottom: 2rem;">User Management</h1>
  <!-- Toasts -->
  <% if (typeof success !== "undefined") { %>
    <div class="toast toast-success"><%= success %></div>
  <% } %>
  <% if (typeof error !== "undefined") { %>
    <div class="toast toast-error"><%= error %></div>
  <% } %>
  <div class="flex-container" style="gap:2.2rem;flex-wrap:wrap;align-items: flex-start;">
    <!-- Add User Form -->
    <div class="card user-form-card" style="min-width:340px;max-width:390px;background:#D6EFD8;">
      <h2 class="card-title" style="margin-bottom: 1.2rem;">Add New User</h2>
      <form method="POST" action="/admin/users/add" class="form-column">
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" name="name" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" minlength="6" required autocomplete="new-password" />
        </div>
        <div class="form-group">
          <label for="role">Role</label>
          <select id="role" name="role" required>
            <option value="" disabled selected>Select Role</option>
            <option value="admin">Admin</option>
            <option value="staff">Staff</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Branch</label>
          <select id="branch" name="branch" required>
            <option value="" disabled selected>Select Branch</option>
            <% branches.forEach(branch => { %>
              <option value="<%= branch.code %>"><%= branch.name %></option>
            <% }) %>
          </select>
        </div>
        <button type="submit" class="btn btn-green" style="margin-top:1.5rem;width:100%;">Add User</button>
      </form>
    </div>
    <!-- User List Table -->
    <div class="card user-table-card" style="flex:2 1 500px; min-width:320px; background:#F6FBF5;">
      <h2 class="card-title" style="margin-bottom: 1.2rem;">All Users</h2>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th style="min-width: 130px;">Name</th>
              <th style="min-width: 180px;">Email</th>
              <th style="min-width: 70px;">Role</th>
              <th style="min-width: 120px;">Branch</th>
              <th style="min-width: 110px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (users.length === 0) { %>
              <tr>
                <td colspan="5" style="text-align:center;">No users found.</td>
              </tr>
            <% } else { %>
              <% users.forEach(user => { %>
                <tr>
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td style="text-transform:capitalize;"><%= user.role %></td>
                  <td>
                    <% let branch = branches.find(b => b.code === user.branch); %>
                    <%= branch ? branch.name : user.branch %>
                  </td>
                  <td>
                    <button type="button" class="btn btn-green btn-small" onclick="openEditUserModal('<%= user.uid %>')">Edit</button>
                    <form method="POST" action="/admin/users/delete/<%= user.uid %>" style="display:inline;">
                      <button type="submit" class="btn btn-red btn-small" onclick="return confirm('Are you sure you want to delete this user?');">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditUserModal()">&times;</span>
    <h2>Edit User</h2>
    <form id="editUserForm" method="POST" autocomplete="off">
      <input type="hidden" id="edit_uid" name="uid" />
      <div class="form-group">
        <label for="edit_name">Full Name</label>
        <input type="text" id="edit_name" name="name" required />
      </div>
      <div class="form-group">
        <label for="edit_role">Role</label>
        <select id="edit_role" name="role" required>
          <option value="admin">Admin</option>
          <option value="staff">Staff</option>
        </select>
      </div>
      <div class="form-group">
        <label for="edit_branch">Branch</label>
        <select id="edit_branch" name="branch" required>
          <% branches.forEach(branch => { %>
            <option value="<%= branch.code %>"><%= branch.name %></option>
          <% }) %>
        </select>
      </div>
      <button type="submit" class="btn btn-green" style="margin-top:1rem;width:100%;">Save Changes</button>
    </form>
  </div>
</div>
<script>
window.allUsers = <%- JSON.stringify(users) %>;
function openEditUserModal(uid) {
  const user = window.allUsers.find(u => u.uid === uid);
  if (!user) return;
  document.getElementById('edit_uid').value = user.uid;
  document.getElementById('edit_name').value = user.name || '';
  document.getElementById('edit_role').value = user.role || '';
  document.getElementById('edit_branch').value = user.branch || '';
  document.getElementById('editUserForm').action = `/admin/users/edit/${user.uid}`;
  document.getElementById('editUserModal').style.display = 'block';
}
function closeEditUserModal() {
  document.getElementById('editUserModal').style.display = 'none';
}
window.onclick = function(event) {
  if (event.target == document.getElementById('editUserModal')) {
    closeEditUserModal();
  }
}
</script>
