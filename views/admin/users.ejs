<% layout('layouts/main') %>
<section class="admin-content user-admin-page">
  <h1 class="page-title user-mgmt-title">User Management</h1>
  <% if (typeof success !== "undefined" && success) { %>
    <div class="toast toast-success"><%= success %></div>
  <% } %>
  <% if (typeof error !== "undefined" && error) { %>
    <div class="toast toast-error"><%= error %></div>
  <% } %>
  <div class="user-cards-row">
    <!-- Add/Edit User Form -->
    <div class="card user-form-card">
      <h2 class="card-title" id="formTitle">Add New User</h2>
      <form id="userForm" method="POST" action="/admin/users/add" class="form-column" autocomplete="off" style="max-width:390px;">
        <input type="hidden" id="form_uid" name="uid" />
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" name="name" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" minlength="6" required autocomplete="new-password" />
        </div>
        <div class="form-group">
          <label for="role">Role</label>
          <select id="role" name="role" required onchange="toggleBranchRequired()">
            <option value="" disabled selected>Select Role</option>
            <option value="admin">Admin</option>
            <option value="staff">Staff</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Branch</label>
          <select id="branch" name="branch">
            <option value="" selected>(None)</option>
            <% branches.forEach(branch => { %>
              <option value="<%= branch.code %>"><%= branch.name %></option>
            <% }) %>
          </select>
        </div>
        <button type="submit" id="formSubmitBtn" class="btn btn-green form-submit-btn">Add User</button>
        <button type="button" id="formCancelBtn" class="btn btn-small" style="margin-top:1.1rem;width:100%;display:none;">Cancel Edit</button>
      </form>
    </div>
    <!-- User List Table -->
    <div class="card user-table-card">
      <h2 class="card-title" style="margin-bottom:1.3rem;">All Users</h2>
      <!-- Search Bar -->
      <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.1rem;">
        <input type="text" id="userSearch" class="input-search" placeholder="Search by name, email, or branch..." style="max-width:340px;">
      </div>
      <div class="table-responsive">
        <table class="data-table" id="usersTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th style="min-width: 180px">Branch</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <% if (users.length === 0) { %>
              <tr>
                <td colspan="5" style="text-align:center;">No users found.</td>
              </tr>
            <% } else { %>
              <% users.forEach(user => { %>
                <tr data-uid="<%= user.uid %>">
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td style="text-transform:capitalize;"><%= user.role %></td>
                  <td>
                    <% let branch = branches.find(b => b.code === user.branch); %>
                    <%= branch ? branch.name : (user.branch || "") %>
                  </td>
                  <td>
                    <div class="action-btn-row">
                      <button type="button" class="btn btn-green btn-small" onclick="editUserInline('<%= user.uid %>')">Edit</button>
                      <form method="POST" action="/admin/users/delete/<%= user.uid %>" style="display:inline;">
                        <button type="submit" class="btn btn-red btn-small" onclick="return confirm('Are you sure you want to delete this user?');">Delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- JS: Inline edit, cancel, branch toggle, search -->
<script>
window.allUsers = <%- JSON.stringify(users) %>;

function toggleBranchRequired() {
  const role = document.getElementById('role').value;
  const branchSelect = document.getElementById('branch');
  if (role === 'admin') {
    branchSelect.value = "";
    branchSelect.required = false;
    branchSelect.disabled = true;
  } else {
    branchSelect.required = true;
    branchSelect.disabled = false;
  }
}

function resetUserForm() {
  document.getElementById('userForm').action = '/admin/users/add';
  document.getElementById('form_uid').value = '';
  document.getElementById('formTitle').textContent = "Add New User";
  document.getElementById('formSubmitBtn').textContent = 'Add User';
  document.getElementById('formSubmitBtn').className = 'btn btn-green form-submit-btn';
  document.getElementById('formCancelBtn').style.display = 'none';
  document.getElementById('name').value = '';
  document.getElementById('email').value = '';
  document.getElementById('email').disabled = false;
  document.getElementById('email').style.background = "#fff";
  document.getElementById('password').required = true;
  document.getElementById('password').value = '';
  document.getElementById('password').disabled = false;
  document.getElementById('password').style.background = "#fff";
  document.getElementById('role').value = '';
  document.getElementById('branch').value = '';
  toggleBranchRequired();
}

function editUserInline(uid) {
  const user = window.allUsers.find(u => u.uid === uid);
  if (!user) return;
  document.getElementById('userForm').action = `/admin/users/edit/${user.uid}`;
  document.getElementById('form_uid').value = user.uid;
  document.getElementById('formTitle').textContent = "Edit User";
  document.getElementById('formSubmitBtn').textContent = 'Save Changes';
  document.getElementById('formSubmitBtn').className = 'btn btn-yellow form-submit-btn';
  document.getElementById('formCancelBtn').style.display = 'block';
  document.getElementById('name').value = user.name || '';
  document.getElementById('email').value = user.email || '';
  document.getElementById('email').disabled = true;
  document.getElementById('email').style.background = "#eee";
  document.getElementById('password').value = '';
  document.getElementById('password').required = false;
  document.getElementById('password').disabled = true;
  document.getElementById('password').style.background = "#eee";
  document.getElementById('role').value = user.role || '';
  document.getElementById('branch').value = user.branch || '';
  toggleBranchRequired();
}

document.getElementById('formCancelBtn').onclick = function() {
  resetUserForm();
};
window.onload = function() {
  resetUserForm();
};

// --- SEARCH FUNCTION ---
document.getElementById('userSearch').addEventListener('keyup', function() {
  const filter = this.value.trim().toLowerCase();
  const tbody = document.getElementById('userTableBody');
  Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(filter) ? "" : "none";
  });
});
</script>

<style>
.action-btn-row {
  display: flex;
  flex-direction: row;
  gap: 0.5rem;
}
.input-search {
  padding: 0.7rem 1rem;
  border-radius: 0.9rem;
  border: 1.4px solid #B0C5B6;
  background: #fff;
  font-size: 1.06rem;
  width: 100%;
  max-width: 340px;
}
.btn-yellow {
  background: #b3ad43 !important;
  color: #fff !important;
}
.btn-yellow:hover { background: #8a870c !important; }
</style>
