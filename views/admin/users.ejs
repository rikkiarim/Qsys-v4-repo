<% layout('layouts/main') %>
<section class="admin-content user-admin-page">
  <h1 class="page-title" style="margin-bottom: 2.2rem;">User Management</h1>
  <% if (typeof success !== "undefined" && success) { %>
    <div class="toast toast-success"><%= success %></div>
  <% } %>
  <% if (typeof error !== "undefined" && error) { %>
    <div class="toast toast-error"><%= error %></div>
  <% } %>
  <div class="user-cards-row">
    <!-- Add/Edit User Form -->
    <div class="card user-form-card">
      <h2 class="card-title" id="formTitle">Add New User</h2>
      <form id="userForm" method="POST" action="/admin/users/add" class="form-column" autocomplete="off">
        <input type="hidden" id="form_uid" name="uid" />
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" name="name" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required autocomplete="off" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" minlength="6" required autocomplete="new-password" />
        </div>
        <div class="form-group">
          <label for="role">Role</label>
          <select id="role" name="role" required>
            <option value="" disabled selected>Select Role</option>
            <option value="admin">Admin</option>
            <option value="staff">Staff</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Branch</label>
          <select id="branch" name="branch" required>
            <option value="" disabled selected>Select Branch</option>
            <% branches.forEach(branch => { %>
              <option value="<%= branch.code %>"><%= branch.name %></option>
            <% }) %>
          </select>
        </div>
        <button type="submit" id="formSubmitBtn" class="btn btn-green" style="margin-top:1.5rem;width:100%;">Add User</button>
        <button type="button" id="formCancelBtn" class="btn btn-small" style="margin-top:1.1rem;width:100%;display:none;">Cancel Edit</button>
      </form>
    </div>
    <!-- User List Table -->
    <div class="card user-table-card">
      <h2 class="card-title">All Users</h2>
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Branch</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (users.length === 0) { %>
              <tr>
                <td colspan="5" style="text-align:center;">No users found.</td>
              </tr>
            <% } else { %>
              <% users.forEach(user => { %>
                <tr>
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td style="text-transform:capitalize;"><%= user.role %></td>
                  <td>
                    <% let branch = branches.find(b => b.code === user.branch); %>
                    <%= branch ? branch.name : user.branch %>
                  </td>
                  <td>
                    <button type="button" class="btn btn-green btn-small" onclick="editUserInline('<%= user.uid %>')">Edit</button>
                    <form method="POST" action="/admin/users/delete/<%= user.uid %>" style="display:inline;">
                      <button type="submit" class="btn btn-red btn-small" onclick="return confirm('Are you sure you want to delete this user?');">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
<script>
window.allUsers = <%- JSON.stringify(users) %>;

function resetUserForm() {
  document.getElementById('userForm').action = '/admin/users/add';
  document.getElementById('form_uid').value = '';
  document.getElementById('formTitle').textContent = "Add New User";
  document.getElementById('formSubmitBtn').textContent = 'Add User';
  document.getElementById('formSubmitBtn').className = 'btn btn-green';
  document.getElementById('formCancelBtn').style.display = 'none';
  document.getElementById('name').value = '';
  document.getElementById('email').value = '';
  document.getElementById('email').disabled = false;
  document.getElementById('password').required = true;
  document.getElementById('password').value = '';
  document.getElementById('password').disabled = false;
  document.getElementById('role').value = '';
  document.getElementById('branch').value = '';
}

function editUserInline(uid) {
  const user = window.allUsers.find(u => u.uid === uid);
  if (!user) return;
  document.getElementById('userForm').action = `/admin/users/edit/${user.uid}`;
  document.getElementById('form_uid').value = user.uid;
  document.getElementById('formTitle').textContent = "Edit User";
  document.getElementById('formSubmitBtn').textContent = 'Save Changes';
  document.getElementById('formSubmitBtn').className = 'btn btn-yellow';
  document.getElementById('formCancelBtn').style.display = 'block';
  document.getElementById('name').value = user.name || '';
  document.getElementById('email').value = user.email || '';
  document.getElementById('email').disabled = true;
  document.getElementById('password').value = '';
  document.getElementById('password').required = false;
  document.getElementById('password').disabled = true;
  document.getElementById('role').value = user.role || '';
  document.getElementById('branch').value = user.branch || '';
}

document.getElementById('formCancelBtn').onclick = function() {
  resetUserForm();
};

window.onload = function() {
  resetUserForm();
};
</script>
